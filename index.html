<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Registro de Pesos</title>
    <style>
      body {
        font-family: Segoe UI;
        margin: 0;
        background: #f4f6f9;
      }

      header {
        background: #1e3c72;
        color: white;
        padding: 20px;
        text-align: center;
        font-size: 22px;
        position: relative;
      }

      .logo {
        position: absolute;
        left: 20px;
        top: 50%;
        transform: translateY(-50%);
        height: 50px;
      }

      .codigo-empresa {
        position: absolute;
        right: 20px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 14px;
        font-weight: 500;
      }

      .container {
        max-width: 1200px;
        margin: 20px auto;
        padding: 20px;
      }

      .card {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        margin-bottom: 20px;
      }

      input,
      select {
        width: 100%;
        padding: 8px;
        margin: 5px 0;
        border-radius: 6px;
        border: 1px solid #ddd;
      }

      button {
        background: #2a5298;
        color: white;
        border: none;
        padding: 10px;
        border-radius: 6px;
        cursor: pointer;
      }

      button:hover {
        background: #1e3c72;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
      }

      th {
        background: #2a5298;
        color: white;
        padding: 6px;
      }

      td {
        padding: 6px;
        border-bottom: 1px solid #eee;
      }

      .success {
        color: green;
        font-weight: bold;
      }

      .hidden {
        display: none;
      }
    </style>
  </head>

  <body>
    <header>
      <img src="Fondo Blanco.jpg" class="logo" alt="Fresh-Pak">
      Registro de Pesos
      <div class="codigo-empresa">R02 POE 29</div>
    </header>

    <div class="container">
      <!-- Login Card -->
      <div class="card" id="loginCard">
        <h3>Ingreso</h3>
        <input type="text" id="nombreOperador" placeholder="Nombre operador">
        <input type="password" id="claveOperador" placeholder="Clave operador">
        <button onclick="ingresarOperador()">Operador</button>
        <p id="msgLogin" style="color:red;"></p>
      </div>

      <!-- Form Card (hidden until operator logs in) -->
      <div class="card hidden" id="formCard">
        <h3>Nuevo Registro</h3>
        <form id="form">
          <input type="text" id="operador" readonly>
          <select id="exportadora" required>
            <option value="">Exportadora</option>
            <option>Fruclem</option>
            <option>JHB</option>
            <option>Talamaya</option>
          </select>
          <select id="categoria" required>
            <option value="">Categoría</option>
            <option>Premium</option>
            <option>Extra</option>
            <option>Fancy</option>
            <option>Choice</option>
            <option>Granel</option>
          </select>
          <select id="variedad" required>
            <option value="">Variedad</option>
            <option>Royal Gala</option>
            <option>Red Delicious</option>
            <option>Granny</option>
            <option>Fuji</option>
            <option>Pink Lady</option>
          </select>
          <select id="salida" required>
            <option value="">Salida</option>
          </select>
          <input type="text" id="calibre" placeholder="Calibre" required>
          <input type="text" id="lote" placeholder="Lote">
          <input type="number" step="0.01" id="peso" placeholder="Peso (kg)" required>
          <button type="submit">Guardar</button>
          <p id="msg" class="success"></p>
        </form>
      </div>

      <!-- Registro de Pesos Card -->
      <div class="card">
        <h3>Registros</h3>
        <table>
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Hora</th>
              <th>Usuario</th>
              <th>Exportadora</th>
              <th>Salida</th>
              <th>Calibre</th>
              <th>Categoria</th>
              <th>Variedad</th>
              <th>Lote</th>
              <th>Peso</th>
            </tr>
          </thead>
          <tbody id="tabla"></tbody>
        </table>
      </div>
    </div>

    <script>
      const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxpq6k7t7izq1zHok-67xHJHPw371CdcrbdLS0AM2IDXqG1d13UySpLHO4E2GS0c001/exec";
      const salidaSelect = document.getElementById("salida");

      for (let i = 1; i <= 41; i++) {
        let option = document.createElement("option");
        option.value = i;
        option.text = i;
        salidaSelect.appendChild(option);
      }

      let nombreActual = "";

      /* LOGIN */
      function ingresarOperador() {
        const nombre = document.getElementById("nombreOperador").value.trim();
        const clave = document.getElementById("claveOperador").value.trim();

        if (!nombre || !clave) {
          document.getElementById("msgLogin").innerText = "Ingrese nombre y clave";
          return;
        }

        if (clave === "fresh") {
          nombreActual = nombre;
          document.getElementById("operador").value = nombreActual;
          cargarRegistros(); // Cargar los registros del día actual
          document.getElementById("loginCard").classList.add("hidden");
          document.getElementById("formCard").classList.remove("hidden");
          cargarDatosPrevios(); // Cargar los datos previos del último registro
        } else {
          document.getElementById("msgLogin").innerText = "Clave incorrecta";
        }
      }

      /* GUARDAR REGISTRO */
      document.getElementById("form").addEventListener("submit", function (e) {
        e.preventDefault();

        const data = {
          operador: nombreActual,
          exportadora: document.getElementById("exportadora").value,
          salida: document.getElementById("salida").value,
          calibre: document.getElementById("calibre").value,
          categoria: document.getElementById("categoria").value,
          variedad: document.getElementById("variedad").value,
          lote: document.getElementById("lote").value,
          peso: document.getElementById("peso").value
        };

        fetch(SCRIPT_URL, {
          method: "POST",
          body: new URLSearchParams(data)
        })
          .then(res => res.json())
          .then(() => {
            document.getElementById("msg").innerText = "Guardado correctamente";
            document.getElementById("form").reset();
            cargarRegistros();  // Recargar los registros del día actual después de guardar

            // Guardar los datos del último registro en localStorage
            localStorage.setItem("operador", nombreActual);
            localStorage.setItem("exportadora", data.exportadora);
            localStorage.setItem("variedad", data.variedad);
            localStorage.setItem("lote", data.lote);
          })
          .catch(err => console.error("Error guardando:", err));
      });

      /* CARGAR REGISTROS */
      function cargarRegistros() {
        fetch(SCRIPT_URL)
          .then(res => res.json())
          .then(data => {
            const tbody = document.getElementById("tabla");
            tbody.innerHTML = "";

            const fechaHoy = new Date();
            const diaHoy = String(fechaHoy.getDate()).padStart(2, "0");
            const mesHoy = String(fechaHoy.getMonth() + 1).padStart(2, "0");
            const añoHoy = fechaHoy.getFullYear();
            const fechaFormatoHoy = `${diaHoy}/${mesHoy}/${añoHoy}`;

            // Solo mostramos registros del día de hoy
            data.reverse().forEach(row => {
              const fechaRegistro = row[0];
              if (fechaRegistro === fechaFormatoHoy) {
                tbody.innerHTML += `
                  <tr>
                    <td>${row[0]}</td>
                    <td>${row[1]}</td>
                    <td>${row[2]}</td>
                    <td>${row[3]}</td>
                    <td>${row[4]}</td>
                    <td>${row[5]}</td>
                    <td>${row[6]}</td>
                    <td>${row[7]}</td>
                    <td>${row[8]}</td>
                    <td>${row[9]}</td>
                  </tr>
                `;
              }
            });
          })
          .catch(err => console.error("Error cargando registros:", err));
      }

      // Cargar los datos previos del último registro
      function cargarDatosPrevios() {
        const operador = localStorage.getItem("operador");
        const exportadora = localStorage.getItem("exportadora");
        const variedad = localStorage.getItem("variedad");
        const lote = localStorage.getItem("lote");

        if (operador) document.getElementById("operador").value = operador;
        if (exportadora) document.getElementById("exportadora").value = exportadora;
        if (variedad) document.getElementById("variedad").value = variedad;
        if (lote) document.getElementById("lote").value = lote;
      }

      // Cargar registros al cargar la página
      window.onload = function() {
        cargarRegistros(); // Esto asegura que los registros se muestren al iniciar la página
      };
    </script>
  </body>
</html>
